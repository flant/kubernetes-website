---
title: Организация доступа к кластеру с помощью файлов kubeconfig
content_type: concept
weight: 60
---

<!-- overview -->

Файлы kubeconfig можно использовать для хранения информации о кластерах, пользователях, пространствах имен и механизмах аутентификации. Инструмент командной строки `kubectl` использует файлы kubeconfig для поиска информации, необходимой для выбора кластера и связи с его API-сервером.

{{< note >}}
Для настройки доступа к кластерам используются *kubeconfig'и* (или файлы kubeconfig). kubeconfig — это имя нарицательное, определяющее категорию такого типа конфигурационных файлов. Другими словами, сами файлы могут называться иначе. 
{{< /note >}}

{{< warning >}}
Используйте kubeconfig'и только из надежных источников. Использование ненадежного kubeconfig'а может привести к выполнению вредоносного кода или открыть злоумышленнику доступ к файлам. Если приходится использовать непроверенный kubeconfig, сначала тщательно изучите его (так же, как вы делаете это с непроверенными shell-скриптами.
{{< /warning>}}

По умолчанию `kubectl` ищет файл с именем `config` в директории `$HOME/.kube`. Ссылаться на kubeconfig'и также можно с помощью переменной окружения `KUBECONFIG` или флага командной строки [`--kubeconfig`](/docs/reference/generated/kubectl/kubectl/).

Пошаговые инструкции по созданию файлов kubeconfig см. в разделе [Настройка доступа к нескольким кластерам](/docs/tasks/access-application-cluster/configure-access-multiple-clusters).




<!-- body -->

## Работа с несколькими кластерами, пользователями и механизмами аутентификации

Предположим, что имеется несколько кластеров, а аутентификация пользователей и компонентов осуществляется различными способами. Например:

- Работающий kubelet аутентифицируется с помощью сертификатов.
- Пользователь аутентифицируется с помощью токенов.
- У администраторов могут быть наборы сертификатов, которые они предоставляют отдельным пользователям.

Kubeconfig'и позволяют должным образом организовать кластеры, пользователей и пространства имен. С их помощью также можно задать контексты для быстрого и простого переключения между кластерами и пространствами имен.

## Контекст

Элемент *context* в файле kubeconfig используется для группировки параметров доступа под удобным именем. У каждого контекста есть три параметра: кластер, пространство имен и пользователь. По умолчанию `kubectl` использует параметры из *текущего контекста* для связи с кластером.

Выбрать текущий контекст можно с помощью следующей команды:
```
kubectl config use-context
```

## Переменная окружения KUBECONFIG

Переменная окружения `KUBECONFIG` содержит список kubeconfig'ов. В Linux и macOS элементы списка разделяются двоеточием. В Windows элементы списка разделяются точкой с запятой. Переменная окружения `KUBECONFIG` является опциональной. Если она не существует, `kubectl` использует kubeconfig по умолчанию – `$HOME/.kube/config`.

Если переменная окружения `KUBECONFIG` существует, `kubectl` использует конфигурацию, которая является результатом объединения файлов, перечисленных в переменной окружения `KUBECONFIG`.

## Объединение файлов kubeconfig

Чтобы посмотреть конфигурацию, введите следующую команду:

```shell
kubectl config view
```

Как упоминалось выше, ее вывод может состоять из одного файла kubeconfig или быть результатом объединения нескольких файлов kubeconfig.

Вот правила, которые `kubectl` использует при объединении файлов kubeconfig:

1. Если задан флаг `--kubeconfig`, использовать только указанный файл и не объединять его с другими. Этот флаг в команде можно использовать только один раз.

   В противном случае, если установлена переменная окружения `KUBECONFIG`, использовать ее для формирования списка файлов, которые должны быть объединены. Объединение файлов, перечисленных в переменной окружения `KUBECONFIG`, проводить в соответствии с правилами ниже:

   * Игнорировать пустые имена файлов.
   * Выдавать ошибки для файлов с содержимым, которое не поддается десериализации.
   * Приоритет за файлом, первым установившим определенное значение или map-ключ.
   * Не менять значение или map-ключ. 
     Пример: Использование первого файла для установки текущего контекста (`current-context`). Допустим, значение `red-user` задают два файла. Тогда будет использоваться значение из первого файла. Даже если во втором файле имеются не противоречащие записи в разделе `red-user`, они все равно отбрасываются.

   Пример задания переменной `KUBECONFIG` смотрите в разделе [Задание переменной окружения KUBECONFIG](/docs/tasks/access-application-cluster/configure-access-multiple-clusters/#set-the-kubeconfig-environment-variable).

   В противном случае использовать файл kubeconfig по умолчанию (`$HOME/.kube/config`) без объединения.
  
1. Определить, какой контекст использовать, по первому "попаданию" в цепочке:

    1. Использовать контекст, заданный флагом командной строки `--context` (если тот существует).
    1. Использовать `current-context` из объединенных файлов kubeconfig.

   На этом этапе допускается пустой контекст.

1. Определить кластер и пользователя. На этом этапе контекст может быть пустым или непустым. Определить кластер и пользователя на основании первого "попадания" в цепочке, которая выполняется дважды: один раз для пользователя и один раз для кластера:

   1. Использовать флаг командной строки, если тот существует: `--user` или `--cluster`.
   1. Если контекст непустой, взять пользователя или кластер из контекста.

   На этом этапе пользователь и кластер могут быть пустыми.

1. Определить, какую информацию о кластере использовать. На этом этапе информация о кластере может быть пустой или непустой. Собрать всю информацию о кластере с помощью цепочки; используется первое "попадание":

   1. Использовать флаги командной строки, если те заданы: `--server`, `--certificate-authority`, `--insecure-skip-tls-verify`.
   1. Использовать атрибуты из объединенных kubeconfig'ов, если те существуют.
   1. Если местоположение сервера отсутствует, завершить работу с ошибкой.

1. Определить, какую информацию о пользователе использовать. Собрать информацию о пользователе, используя те же правила, что и для информации о кластере, за исключением того, что для каждого пользователя допустим только один способ аутентификации.

   1. Использовать флаги командной строки, если те заданы: `--client-certificate`, `--client-key`, `--username`, `--password`, `--token`.
   1. Использовать поля `user` из объединенных файлов kubeconfig.
   1. При наличии двух конфликтующих способов завершить работу с ошибкой.

1. Если какие-то данные по-прежнему отсутствуют, использовать значения по умолчанию или запросить информацию для аутентификации.

## Пути

Пути к файлам и директориям в kubeconfig'ах указываются относительно местоположения kubeconfig-файла. Пути к файлам в командной строке указываются относительно текущей рабочей директории. В `$HOME/.kube/config` относительные пути хранятся относительно, а абсолютные – абсолютно.

## Прокси

Можно настроить `kubectl` на использование прокси-сервера для каждого кластера с помощью `proxy-url` в файле kubeconfig, как показано ниже:

```yaml
apiVersion: v1
kind: Config

clusters:
- cluster:
    proxy-url: http://proxy.example.org:3128
    server: https://k8s.example.org/k8s/clusters/c-xxyyzz
  name: development

users:
- name: developer

contexts:
- context:
  name: development
```


## {{% heading "whatsnext" %}}


* [Настройка доступа к нескольким кластерам](/docs/tasks/access-application-cluster/configure-access-multiple-clusters/)
* [Справка по `kubectl config`](/docs/reference/generated/kubectl/kubectl-commands#config)
